---
title: "ABC7 Southern California Neighborhood Safety Tracker"
# author: "John Kelly"
# date: Sys.time()
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(htmlwidgets)
library(htmltools)
library(sf)

```
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

![<popupchatter>Updated `r format(Sys.time(), '%B %d, %Y')` by the ABC7 Data Team</popupchatter>](https://github.com/abcotvdata/safetytracker_losangeles/raw/main/docs/banner_kabc.png)

```{css, echo=FALSE}

h1.title {
  font-family: roboto;
  color: transparent;
  font-weight: 700;
  text-align: left;
  font-size: 12px;
  padding: 0px;
}

.date {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 10px;
    padding: 5px;
}

select {
  margin: 0px;
  width: 225px;
  color: #00318b;
  padding: 5px 35px 5px 5px;
    font-family: roboto;
  font-size: 18px;
  font-weight: 900;
  border: 0px;
  height: 34px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Arrow-down.svg) 96% / 15% no-repeat #f2f2f2;
}

h1 {
  font-family: roboto;
  color: black;
  font-weight: bolder;
  text-align: left;
  font-size: 36px;
  margin-top: 0;
  margin-bottom: 0;
}

h2 {
  font-family: roboto;
  font-weight: 500;
  color: black;
  text-align: center;
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 2;
}

bignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 60px;
    line-height: 65px;
  height: 65px;
    margin-top: 0;
  margin-bottom: 0;
}

subhead {
  font-family: roboto;
  color: black;
  font-weight: 700;
  text-align: left;
  font-size: 20px;
    padding: 0px;
}

body {
  color: black;
  font-family: roboto;
  font-weight: 400;
  font-size: 18px;
}

popuptitle {
  color: #00318b;
  font-family: roboto;
  font-weight: 700;
  font-size: 15px;
  text-align: left;
}

popupchatter {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 12px;
  margin-top: 0;
  margin-bottom: 2;
}

h8 {
  color: #00318b;
  font-family: roboto;
  font-weight: 900;
  font-size: 18px;
}

table {
  font-family: roboto;
  width: 100%;
}

tr {
  border-bottom: thin solid #99a0a5;
}
  
td {
  text-align: right;
  padding: 1px;
}

th {
  text-align: right;
  padding: 1px;
}
  
   * {
      box-sizing: border-box;
   }
   .card {
      color: white;
      float: left;
      width: calc(25% - 10px);
      padding: 5px;
      border-radius: 10px;
      margin-left: 3px;
      margin-right: 3px;
      margin-top: 3px;
      margin-bottom: 3px;
      height: 100%;
   }
   .card p {
   font-family: roboto;
   text-align: center;
   font-size: 14px;
  margin-bottom: 0;
   }
   .cardContainer:after {
      content: "";
      display: table;
      clear: both;
   }
   @media screen and (max-width: 650px) {
      .card {
         width: 100%;
      }
      h1.title {
        font-size: 22px;
      }
   }
```

```{r population, include=FALSE}
# set value of sf_population
sf_population <- 815201
```

<h2>ABC7 is tracking crime and safety in cities across Southern California. 

<br>You can choose which crime to examine: <select onchange="window.location=this.value">
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker.html">Homicides</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_VehicleThefts.html">Vehicle Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_Assaults.html">Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_Burglaries.html">Burglaries</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_Robberies.html">Robberies</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_SexualAssaults.html">Sexual Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker_Thefts.html">Thefts</option>
</select></h2>
<h2>Choose a different area to explore: <select onchange="window.location=this.value">
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Southern_California_Safety_Tracker.html">Los Angeles County</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Los_Angeles_Safety_Tracker.html">City of Los Angeles</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Southern_California_Safety_Tracker.html">Orange County</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Southern_California_Safety_Tracker.html">Riverside County</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Southern_California_Safety_Tracker.html">San Bernardino County</option>
<option value="https://abcotvdata.github.io/safetytracker_losangeles/Southern_California_Safety_Tracker.html">Ventura County</option>
</select></h2>
<br>
There were <h8>`r prettyNum(murders21,big.mark=",")`</h8> homicides in 2021 across every Southern California police jurisdiction, according to data that law enforcement agencies report to the state of Californina. In 2019, the data show that number was <h8>`r prettyNum(murders19,big.mark=",")`</h8> a month.

The risk is not the same area to area.

ABC7's data team looked at data that every local police agency reported to the California Department of Justice through 2021, the latest date for which records are available. Totals here include murders, but not involuntary manslaughter or justifiable homicide.

<subhead>A closer look at Southern California homicides where you live</subhead>

The map color codes each community by the homicide rate in 2021. You can also click the box in the bottom right corner to see neighborhoods by the number of killings.

You can find your neighborhood by using the box at the top of the map to search for any street, place, landmark or zip code to zoom to that location.
<br>
```{r cars, echo=FALSE,out.width='100%',out.height='600'}
# MURDER MAP

# Set bins for numbers of crimes for murders map
murderbins1 <- c(0,
                3,
                5,
                10,
                20,
                500)
murderbins2 <- c(0,
                3,
                10,
                25,
                50,
                200)
murderpal1 <- colorBin(c("#aecfe6",
                             "#2787d6",
                             "#0058f6",
                             "#003ca6",
                             "#00215c"), murders_region$rate21, bins = murderbins1,na.color = "#51585f")

murderpal2 <- colorBin(c("#aecfe6",
                             "#2787d6",
                             "#0058f6",
                             "#003ca6",
                             "#00215c"), murders_region$total21, bins = murderbins2,na.color = "#51585f")

                            
# Create labels for murders map
murderlabel_region <- paste(sep="",
                     "<popuptitle>",
                     murders_region$total21,
                     ifelse(murders_region$total21==1,
                     " homicide </popuptitle><br>",
                     " homicides </popuptitle><br>"),
                     " in 2021 in <b>",
                     murders_region$place,
                     "</b> home to an estimated ",
                     prettyNum(murders_region$population, big.mark=","),
                     " people.
<br>
<table>      
      <tr>
				<th></th>
				<th>Total</th>
				<th>Rate</th>
			</tr>
			<tr>
				<td>2019</td>
				<td>",
murders_region$total19,
"</td>
				<td>",
murders_region$rate19,
"</td>
			</tr>
			<tr>
				<td>2020</td>
				<td>",
murders_region$total20,
"</td>
				<td>",
murders_region$rate20,
"</td>
			</tr>
						<tr>
				<td>2021</td>
				<td>",
murders_region$total21,
"</td>
				<td>",
murders_region$rate21,
"</td>
			</tr>
						<tr>
				<td>3-year Average</td>
				<td>",
murders_region$avg_prior3years,
"</td>
				<td>",
murders_region$rate_prior3years,
"</td>
			</tr>
</table>")


# Creating police beats map for types of crimes
socal_murder_map <- leaflet(murders_region, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.5, zoomDelta=0.5)) %>%
  htmlwidgets::onRender("function(el, x) {
L.control.zoom({ position: 'topright' }).addTo(this)
}") %>%
  setView(-118.24, 34.05, zoom = 10) %>% 
  addProviderTiles(provider = "Esri.WorldImagery") %>%
  addProviderTiles(provider = "CartoDB.PositronOnlyLabels") %>%
  addPolygons(color = "white", 
              popup = murderlabel_region,
              popupOptions = popupOptions(maxWidth ="200", 
                                          minWidth ="200"),
              weight = 2, 
              smoothFactor = 0.5,
              opacity = 0.6, 
              fillOpacity = 0.6,
              fillColor = ~murderpal1(rate21),
              group="Rate") %>% 
    addPolygons(color = "white", 
              popup = murderlabel_region,
              popupOptions = popupOptions(maxWidth ="200", 
                                          minWidth ="200"),
              weight = 2, 
              smoothFactor = 0.5,
              opacity = 0.6, 
              fillOpacity = 0.6,
              fillColor = ~murderpal2(total21),
              group="Number") %>% 
  addSearchOSM(options = searchOptions(autoCollapse=FALSE, minLength = 3,zoom=13, position="topleft")) %>%
    onRender("function(el, x) {
        $('input.search-input')[0].placeholder = 'Search street, place or zip code'
        }") %>%
  addLegend(opacity = 0.6,
            values = murders_region$rate21, 
            pal = murderpal1,
            position = "bottomleft", 
            title = paste(sep="","<popuptitle>Murder Rate<br><popupchatter>Murders/100K people<br>"),
            group = "Rate",
            className = "info legend Rate") %>%
  addLegend(opacity = 0.6,
            values = murders_region$total21, 
            pal = murderpal2,
            position = "bottomleft", 
            title = paste(sep="","<popuptitle>Murders<br>"),
            group = "Number",
            className = "info legend Number") %>%
  addLayersControl(
    baseGroups = c("Rate","Number"),
    options = layersControlOptions(collapsed = FALSE),
    position = 'bottomright') %>% hideGroup(c("Number")) %>%
   htmlwidgets::onRender("
      function(el, x) {
         var updateLegend = function () {
            var selectedGroup = document.querySelectorAll('input:checked')[0].nextSibling.innerText.substr(1);

            document.querySelectorAll('.legend').forEach(a => a.hidden=true);
            document.querySelectorAll('.legend').forEach(l => {
               if (l.classList.contains(selectedGroup)) l.hidden=false;
            });
         };
         updateLegend();
         this.on('baselayerchange', el => updateLegend());
      }"
   )
  
socal_murder_map
```
<br>
<br>
<!-- <subhead> Look up year by year city table-->
<iframe title="Homicides by area across Southern California" aria-label="Table" id="datawrapper-chart-Dnmam" src="https://datawrapper.dwcdn.net/Dnmam/3/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="3289" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>
<br>
<!-- <subhead>Clearance rates table -->
<br>
<br>
<!-- <subhead>Risk of property crime in various cities chart -->